Layout = require '../../src/Layout'
{object} = require 'utila'

{open, get, conf} = do ->
  show = (layout) ->
    got = layout.get()
    got = got.replace /<[^>]+>/g, ''

  defaultBlockConfig =
    linePrependor: options: amount: 2

  c = (add = {}) ->
    object.append defaultBlockConfig, add

  ret = {}

  ret.open = (block, name, top = 0, bottom = 0) ->
    config = c
      blockPrependor: options: amount: top
      blockAppendor: options: amount: bottom

    b = block.openBlock config, name
    b.write name + ' | top ' + top + ' bottom ' + bottom
    b

  ret.get = (layout) ->
    layout.get().replace(/<[^>]+>/g, '')

  ret.conf = (props) ->
    config = {}
    if props.left?
      object.appendOnto config, linePrependor: options: amount: props.left

    if props.right?
      object.appendOnto config, lineAppendor:  options: amount: props.right

    if props.top?
      object.appendOnto config, blockPrependor: options: amount: props.top

    if props.bottom?
      object.appendOnto config, blockAppendor:  options: amount: props.bottom

    if props.width?
      object.appendOnto config, width: props.width

    if props.bullet is yes
      object.appendOnto config, linePrependor: options: bullet: {char: '-', alignment: 'left'}

    config

  ret


describe "Layout", ->
  describe "inline inputs", ->
    it "should be merged", ->
      l = new Layout

      l.write 'a'
      l.write 'b'

      get(l).should.equal 'ab'

    it "should be correctly wrapped", ->
      l = new Layout
      block = l.openBlock conf width: 20
      block.write '123456789012345678901234567890'
      block.close()
      get(l).should.equal '12345678901234567890\n1234567890'

    it "should trim from left when wrapping to a new line", ->
      l = new Layout
      block = l.openBlock conf width: 20
      block.write '12345678901234567890 \t 123456789012345678901'
      block.close()
      get(l).should.equal '12345678901234567890\n12345678901234567890\n1'

    it "should handle line breaks correctly", ->
      l = new Layout
      block = l.openBlock conf width: 20
      block.write '\na\n\nb\n'
      block.close()
      get(l).should.equal '\na\n\nb\n'

    it "should not put extra line breaks when a line is already broken", ->
      l = new Layout
      block = l.openBlock conf width: 20
      block.write '01234567890123456789\n0123456789'
      block.close()
      get(l).should.equal '01234567890123456789\n0123456789'

  describe "horizontal margins", ->
    it "should account for left margins", ->
      l = new Layout
      block = l.openBlock conf width: 20, left: 2
      block.write '01'
      block.close()
      get(l).should.equal '  01'

    it "should account for right margins", ->
      l = new Layout
      block = l.openBlock conf width: 20, right: 2
      block.write '01'
      block.close()
      get(l).should.equal '01  '

    it "should account for both margins", ->
      l = new Layout
      block = l.openBlock conf width: 20, right: 2, left: 1
      block.write '01'
      block.close()
      get(l).should.equal ' 01  '

    it "should break lines according to left margins", ->
      l = new Layout
      global.tick = yes
      block = l.openBlock conf width: 20, left: 2
      block.write '01234567890123456789'
      block.close()
      global.tick = no
      get(l).should.equal '  01234567890123456789'

    it "should break lines according to right margins", ->
      l = new Layout
      block = l.openBlock conf width: 20, right: 2
      block.write '01234567890123456789'
      block.close()
      get(l).should.equal '01234567890123456789  '

    it "should break lines according to both margins", ->
      l = new Layout
      block = l.openBlock conf width: 20, right: 2, left: 1
      block.write '01234567890123456789'
      block.close()
      get(l).should.equal ' 01234567890123456789  '

    it "should break lines according to terminal width", ->
      l = new Layout terminalWidth: 20
      block = l.openBlock conf right: 2, left: 1
      block.write '01234567890123456789'
      block.close()

      # Note: We don't expect ' 01234567890123456  \n 789  ',
      # since the first line (' 01234567890123456  ') is a full line
      # according to layout.config.terminalWidth and doesn't need
      # a break line.
      get(l).should.equal ' 01234567890123456   789  '

  describe "lines and blocks", ->
    it "should put one break line between: line, block", ->
      l = new Layout
      l.write 'a'
      l.openBlock().write('b').close()
      get(l).should.equal 'a\nb'

    it "should put one break line between: block, line", ->
      l = new Layout
      l.openBlock().write('a').close()
      l.write 'b'
      get(l).should.equal 'a\nb'

    it "should put one break line between: line, block, line", ->
      l = new Layout
      l.write 'a'
      l.openBlock().write('b').close()
      l.write 'c'
      get(l).should.equal 'a\nb\nc'

    it "margin top should work for: line, block", ->
      l = new Layout
      l.write 'a'
      l.openBlock(conf top: 2).write('b').close()
      get(l).should.equal 'a\n\n\nb'

    it "margin top should work for: block, line", ->
      l = new Layout
      l.openBlock(conf top: 1).write('a').close()
      l.write 'b'
      get(l).should.equal '\na\nb'

    it "margin top should work for: block, line, when block starts with a break", ->
      l = new Layout
      l.openBlock(conf top: 1).write('\na').close()
      l.write 'b'
      get(l).should.equal '\n\na\nb'

    it "margin top should work for: line, block, when line ends with a break", ->
      l = new Layout
      l.write 'a\n'
      l.openBlock(conf top: 1).write('b').close()
      get(l).should.equal 'a\n\n\nb'

    it "margin top should work for: line, block, when there are two breaks in between", ->
      l = new Layout
      l.write 'a\n'
      l.openBlock(conf top: 1).write('\nb').close()
      get(l).should.equal 'a\n\n\n\nb'

    it "margin bottom should work for: line, block", ->
      l = new Layout
      l.write 'a'
      l.openBlock(conf bottom: 1).write('b').close()
      get(l).should.equal 'a\nb\n'

    it "margin bottom should work for: block, line", ->
      l = new Layout
      l.openBlock(conf bottom: 1).write('a').close()
  